l.安裝nginx服務器 + php-fpm

需要完成的工作列表：
1.安裝好nginx服務器，並設定成開機自動啟動的服務
2.安裝好php-fpm，並設定成開機自動啟動的服務
3.設定nginx.conf讓nginx服務器可以解釋*.php的檔案

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
1.安裝好nginx服務器，並設定成開機自動啟動的服務

切換成root身分
$ sudo -i

更新套件庫
# apt-get update

安裝編譯需要的工具和函式庫
# apt-get install build-essential
# apt-get install libtool

切換目錄，待會兒下載的tar.gz都會放在這裡
# cd /usr/local/src

下載zlib、pcre、openssl原始碼的tar.gz包，然後解壓縮
# wget http://zlib.net/zlib-1.2.8.tar.gz
# tar -zxvf zlib-1.2.8.tar.gz

# wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.36.tar.gz
# tar -zxvf pcre-8.36.tar.gz

# wget https://www.openssl.org/source/openssl-1.0.1j.tar.gz
# tar -zxvf openssl-1.0.1j.tar.gz

下載nginx的原始碼tar.gz，解壓縮之後，進入nginx-1.6.2目錄
# wget http://nginx.org/download/nginx-1.6.2.tar.gz
# tar -zxvf nginx-1.6.2.tar.gz
# cd nginx-1.6.2

查看一下有什麼configure options
# ./configure --help

然後./configure
# ./configure --prefix=/usr/local/nginx-1.6.2 \
--user=www-data \
--group=www-data \
--with-http_ssl_module \
--with-pcre=/usr/local/src/pcre-8.36 \
--with-zlib=/usr/local/src/zlib-1.2.8 \
--with-openssl=/usr/local/src/openssl-1.0.1j

如果沒有問題，終端機會像這樣回應
Configuration summary
  + using PCRE library: /usr/local/src/pcre-8.36
  + using OpenSSL library: /usr/local/src/openssl-1.0.1j
  + md5: using OpenSSL library
  + sha1: using OpenSSL library
  + using zlib library: /usr/local/src/zlib-1.2.8

  nginx path prefix: "/usr/local/nginx-1.6.2"
  nginx binary file: "/usr/local/nginx-1.6.2/sbin/nginx"
  nginx configuration prefix: "/usr/local/nginx-1.6.2/conf"
  nginx configuration file: "/usr/local/nginx-1.6.2/conf/nginx.conf"
  nginx pid file: "/usr/local/nginx-1.6.2/logs/nginx.pid"
  nginx error log file: "/usr/local/nginx-1.6.2/logs/error.log"
  nginx http access log file: "/usr/local/nginx-1.6.2/logs/access.log"
  nginx http client request body temporary files: "client_body_temp"
  nginx http proxy temporary files: "proxy_temp"
  nginx http fastcgi temporary files: "fastcgi_temp"
  nginx http uwsgi temporary files: "uwsgi_temp"
  nginx http scgi temporary files: "scgi_temp"

編譯
# make

安裝
# make install

這樣就把nginx安裝到/usr/local/nginx-1.6.2目錄了
可是在Cubian x1上面安裝nginx，我發現了一件讓我吐血的事
# cd /usr/local/nginx-1.6.2
# ls -al

終端機打印了
總計 24
drwxr-sr-x  6 root staff 4096 11月 22 00:26 .
drwxrwsr-x 11 root staff 4096 11月 22 01:04 ..
drwxr-sr-x  2 root staff 4096 11月 22 00:26 conf
drwxr-sr-x  2 root staff 4096 11月 22 00:26 html
drwxr-sr-x  2 root staff 4096 11月 22 00:26 logs
drwxr-sr-x  2 root staff 4096 11月 22 00:26 sbin

所有的目錄還有裡面裝的檔案，他們的群組都變成了staff
然後多了一個s的權限（我不再列出，你自已切進去執行ls -al自已瞧瞧）
我老實說好了
我根本不知道那個s的權限是幹什麼吃的
我想要的權限很簡單，就是
所有在/usr/local/nginx-1.6.2相關的檔案和目錄
擁有人都是root，然後群組都是www-data
沒有什麼（苟庇）s權限，檔案或是目錄的owner和同一個group都至少會有rw的權限
基於這樣的邏輯，我再執行了下列指令，修改權限
# cd /usr/local/
# chmod -R g-s ./nginx-1.6.2
# chmod -R g+w ./nginx-1.6.2
# chown -R root:www-data ./nginx-1.6.2

最後作一個Symbolic Link
# cd /usr/local/
# ln -s nginx-1.6.2 nginx

在啟動nginx之前，先給它搞一個啟動腳本，也就是init script
參考資料：
http://www.rackspace.com/knowledge_center/article/ubuntu-and-debian-adding-an-nginx-init-script

把下面的內容，另存成 /etc/init.d/nginx

#! /bin/sh
 
### BEGIN INIT INFO
# Provides:          nginx
# Required-Start:    $all
# Required-Stop:     $all
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: starts the nginx web server
# Description:       starts nginx using start-stop-daemon
### END INIT INFO
 
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON=/usr/local/nginx/sbin/nginx
NAME=nginx
DESC=nginx
 
test -x $DAEMON || exit 0
 
# Include nginx defaults if available
if [ -f /etc/default/nginx ] ; then
    . /etc/default/nginx
fi
 
set -e
 
. /lib/lsb/init-functions
 
case "$1" in
  start)
    echo -n "Starting $DESC: "
    start-stop-daemon --start --quiet --pidfile /usr/local/nginx/logs/$NAME.pid \
        --exec $DAEMON -- $DAEMON_OPTS || true
    echo "$NAME."
    ;;
  stop)
    echo -n "Stopping $DESC: "
    start-stop-daemon --stop --quiet --pidfile /usr/local/nginx/logs/$NAME.pid \
        --exec $DAEMON || true
    echo "$NAME."
    ;;
  restart|force-reload)
    echo -n "Restarting $DESC: "
    start-stop-daemon --stop --quiet --pidfile \
        /usr/local/nginx/logs/$NAME.pid --exec $DAEMON || true
    sleep 1
    start-stop-daemon --start --quiet --pidfile \
        /usr/local/nginx/logs/$NAME.pid --exec $DAEMON -- $DAEMON_OPTS || true
    echo "$NAME."
    ;;
  reload)
      echo -n "Reloading $DESC configuration: "
      start-stop-daemon --stop --signal HUP --quiet --pidfile /usr/local/nginx/logs/$NAME.pid \
          --exec $DAEMON || true
      echo "$NAME."
      ;;
  status)
      status_of_proc -p /usr/local/nginx/logs/$NAME.pid "$DAEMON" nginx && exit 0 || exit $?
      ;;
  *)
    N=/etc/init.d/$NAME
    echo "Usage: $N {start|stop|restart|reload|force-reload|status}" >&2
    exit 1
    ;;
esac
 
exit 0

不要忘記它的擁有人和群組都是root，權限值是755
# chown root:root /etc/init.d/nginx
# chmod 755 /etc/init.d/nginx

剛才搞了個啟動腳本/etc/init.d/nginx
現在你可以用這樣的指令啟動nginx
# service nginx start
或是
# /etc/init.d/nginx start
兩個指令是同效的

然後停止nginx就用
# service nginx stop
或是
# /etc/init.d/nginx stop

重新啟動就用
# service nginx restart
或是
# /etc/init.d/nginx restart

重新載入組態檔就用
# service nginx reload
或是
# /etc/init.d/nginx reload

如果要看現在nginx的啟動狀態，就執行
# service nginx status
或是
# /etc/init.d/nginx status

如果要查看nginx有沒有正常啟動
還可以這樣下指令
# ps aux | grep nginx

然後終端機會打印
root      9792  0.0  0.0   3728   616 ?        Ss   02:08   0:00 nginx: master process /usr/local/nginx/sbin/nginx
www-data  9793  0.0  0.0   3868  1228 ?        S    02:08   0:00 nginx: worker process      
root      9802  0.0  0.0   4028   764 pts/0    S+   02:13   0:00 grep nginx

這就表示nginx已經啟動
或是你也可以這樣下指令檢查
# netstat -anp|grep nginx

然後終端機會打印
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      9792/nginx      
unix  3      [ ]         STREAM     CONNECTED     122327   9792/nginx          
unix  3      [ ]         STREAM     CONNECTED     122326   9792/nginx 

這樣也是表示nginx已經啟動

有了init script啟動腳本（/etc/init.d/nginx）
接下來要設定開機的時候自動啟動nginx服務（第一次執行update-rc.d指令）
# update-rc.d -f nginx defaults

順便一提如果要讓nginx取消開機自動執行，指令是： 
# update-rc.d -f nginx disable

然後再打開就是
# update-rc.d -f nginx enable

重新開機之後，執行
# netstat -anp | grep nginx

終端機打印了
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      4265/nginx      
unix  3      [ ]         STREAM     CONNECTED     5111     4265/nginx          
unix  3      [ ]         STREAM     CONNECTED     5110     4265/nginx     

耶，這樣就完成了第一個工作
可以到筆記型電腦上，打開Firefox或是Chrome瀏覽器
然後在網址列輸入Cubian服務器的IP地址：
http://192.168.0.162

看看有沒有看到nginx server預設放置在
/usr/local/nginx/html/index.html
的首頁？

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
2.安裝好php-fpm，並設定成開機自動啟動的服務

接下來要安裝php-fpm

參考了php官網的文件
http://php.net/manual/en/install.unix.nginx.php

其他民間文件（這裡有示範/etc/init.d/php-fpm啟動腳本怎麼寫）
http://www.howtoforge.com/how-to-build-php-5.5-php-fpm-and-fastcgi-with-ioncube-loader-zend-opcache-and-apcu-for-ispconfig3-debian-wheezy

簡體中文文件
http://www.nginx.cn/231.html

先安裝依賴套件
# apt-get install build-essential
# apt-get install libfcgi-dev libfcgi0ldbl libjpeg62-dbg libmcrypt-dev libssl-dev libc-client2007e libc-client2007e-dev libxml2-dev

接著我進入Cubian的mate圖形介面，到php官網，
把php-5.5.19.tar.gz下載到/usr/local/src目錄裡
連結在這裡
http://php.net/downloads.php
（我很想在終端機直接用wget就下載，可是不成功）

切換到/usr/local/src目錄
# cd /usr/local/src

稍早前的openssl-1.0.1j要編譯後，然後安裝
待會兒php的原始碼才有openssl的函式庫可以用
# cd openssl-1.0.1j
# ./config --prefix=/usr/local/openssl-1.0.1j
# make
# make test
# make install

接下來是php的安裝步驟
解壓縮、切換目錄、組態、編譯、測試、安裝
# tar zxvf php-5.5.19.tar.gz
# cd php-5.5.19
# ./configure --prefix=/usr/local/php-5.5.19 --enable-fpm --with-mysql --with-openssl=/usr/local/openssl-1.0.1j
# make
# make test
# make install

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊


